# Universal AI Market - Agent Hub

Agent Hub 是整个 AI 代购系统的**协调中心**，负责编排多个 AI Agent 之间的交互，实现自动化的商品发现、价格协商和跨链结算。

---

## 系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         前端 (apps/market)                       │
│                      http://localhost:3001                       │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │  Buyer Agent Config (浏览器端)                               ││
│  │  - 钱包私钥（仅存浏览器内存，不发送到服务器）                    ││
│  │  - 预算、购物目标、砍价策略、支付链选择                         ││
│  └─────────────────────────────────────────────────────────────┘│
└───────────────────────────────┬─────────────────────────────────┘
                                │ SSE 事件流 + 配置参数
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Agent Hub (apps/agent)                        │
│                      http://localhost:8080                       │
│                                                                  │
│  ┌─────────────────┐   ┌─────────────────┐   ┌────────────────┐ │
│  │  Multi-Agent    │   │   工具调用       │   │   SSE 输出     │ │
│  │    协调器       │   │   (Market API)   │   │   (前端订阅)   │ │
│  │  + LLM (Qwen)   │   │                 │   │               │ │
│  └────────┬────────┘   └────────┬────────┘   └────────────────┘ │
└───────────┼─────────────────────┼───────────────────────────────┘
            │                     │
    ┌───────┴───────┐             │
    ▼               ▼             ▼
┌─────────┐   ┌─────────────────────────────┐   ┌──────────────┐
│ Buyer   │   │   Seller Agent Service      │   │   Market     │
│ Agent   │   │   (单服务，按请求传入配置)     │   │   Backend    │
│         │   │   - sellerConfig per request│   │              │
│         │   │   - 支持 N 个卖家身份         │   │              │
└─────────┘   └─────────────────────────────┘   └──────────────┘
```

**说明**：
- **Seller Agent** 是一个服务，通过请求中的 `sellerConfig` 参数支持不同卖家身份和风格
- 每个请求可以指定：卖家名称、砍价风格（aggressive/pro/friendly）、底价策略等
- 也可以部署多个实例用于负载均衡或隔离

---

## Agent 职责分工

| Agent | 职责 | 关键能力 |
|-------|------|----------|
| **Agent Hub** | 协调中心 | 编排多 Agent 交互、管理会话状态、输出 SSE 事件流 |
| **Buyer Agent** | 买家代理 | 砍价策略、预算控制、交易签名 |
| **Seller Agent** | 卖家客服 | 价格报价、风格化对话、成交确认 |

---

## 多 Agent 协作流程

### 协作流程图

```
                              ┌─────────────────┐
                              │   Agent Hub     │
                              │   (协调中心)     │
                              └────────┬────────┘
                                       │
               ┌───────────────────────┼───────────────────────┐
               │                       │                       │
               ▼                       │                       ▼
      ┌─────────────────┐              │              ┌─────────────────┐
      │  Buyer Agent    │              │              │  Seller Agent   │
      │  (买家代理)      │              │              │  (卖家客服)      │
      └─────────────────┘              │              └─────────────────┘
               │                       │                       │
               │    ┌──────────────────┴──────────────────┐    │
               │    │           砍价循环                    │    │
               │    │  ┌────────────────────────────────┐ │    │
               │    │  │ 1. Hub 向 Buyer 请求出价        │ │    │
               │    │  │ 2. Buyer 生成砍价消息           │ │    │
               │    │  │ 3. Hub 向 Seller 发送买家消息   │ │    │
               │    │  │ 4. Seller 生成报价回复          │ │    │
               │    │  │ 5. Hub 将报价发给 Buyer 判断    │ │    │
               │    │  │ 6. 重复直到 Buyer 接受或放弃    │ │    │
               │    │  └────────────────────────────────┘ │    │
               │    └─────────────────────────────────────┘    │
               │                       │                       │
               │    ┌──────────────────┴──────────────────┐    │
               │    │           成交确认                    │    │
               │    │  ┌────────────────────────────────┐ │    │
               │    │  │ 7. Hub 向 Seller 发送聊天记录   │ │    │
               │    │  │ 8. Seller 分析并返回成交价      │ │    │
               │    │  └────────────────────────────────┘ │    │
               │    └─────────────────────────────────────┘    │
               │                       │                       │
               │    ┌──────────────────┴──────────────────┐    │
               │    │           签名结算                    │    │
               │    │  ┌────────────────────────────────┐ │    │
               │    │  │ 9. Hub 向 Buyer 请求签名        │ │    │
               │    │  │ 10. Buyer 签署交易              │ │    │
               │    │  │ 11. 提交跨链结算                │ │    │
               │    │  └────────────────────────────────┘ │    │
               │    └─────────────────────────────────────┘    │
               │                       │                       │
               ▼                       ▼                       ▼
```

### 流程说明

**第一阶段：商品发现**

用户输入购买意向（如"帮我买一把 10 USDC 以内的武器"），Agent Hub 自动搜索市场，筛选符合预算的商品和店铺。

**第二阶段：多卖家并行砍价**

Agent Hub 同时派出 Buyer Agent 与多个 Seller Agent 进行价格谈判：
- 每个 Seller Agent 有不同的谈判风格（aggressive / pro / friendly）
- Buyer Agent 根据预算和策略自动出价
- 所有对话通过 SSE 实时推送给前端展示

**第三阶段：价格确定**

砍价结束后，Agent Hub 将完整聊天记录发送给 Seller Agent，由其分析对话内容并提取最终成交价格。这确保了对话中达成的价格与实际成交价一致。

**第四阶段：签名与结算**

Buyer Agent 签署交易后，通过 ZetaChain 完成跨链结算。

---

## 关键技术细节

### 1. 交易签名验证

采用 EIP-712 结构化签名，确保交易不可篡改：
- Buyer Agent 持有用户授权的私钥
- 签名内容包含：买家地址、卖家地址、成交价格、NFT 合约、Token ID、过期时间
- 智能合约验证签名后才会执行转账

### 2. 预算控制

Buyer Agent 实现多层预算限制：
- 单笔交易上限
- 每日总预算
- 实时余额追踪

砍价过程中，Buyer Agent 会自动拒绝超出预算的报价。

### 3. 会话隔离

支持多用户并发使用：
- 每个会话有独立的 Session ID
- 多卖家砍价时，每个卖家有独立的对话上下文
- 避免不同用户或不同卖家之间的数据混淆

### 4. SSE 事件流

前端通过 Server-Sent Events 实时接收：
- 聊天消息（买家/卖家/系统）
- 工具调用状态
- 时间线进度
- 交易状态更新

---

## 快速启动

```bash
# 终端 1: Market 前端
cd apps/market && pnpm dev

# 终端 2: Agent Hub
cd apps/agent && pnpm dev

# 终端 3: Buyer Agent
cd apps/buyer-agent && pnpm dev

# 终端 4: Seller Agent
cd apps/seller-agent && pnpm dev
```

---

## 环境配置

```bash
# apps/agent/.env
PORT=8080
WEB_BASE_URL=http://localhost:3001

# Seller Agent URL（单服务，支持多卖家配置）
SELLER_AGENT_URL=http://localhost:8081/api/seller/chat

# LLM 配置（用于生成砍价对话）
MODEL=qwen3-max
OPENAI_API_KEY=your-api-key
OPENAI_BASE_URL=https://dashscope-intl.aliyuncs.com/compatible-mode/v1
```

### LLM 模式

启动时会自动测试 LLM 连接：

```
[agent] 测试 LLM 连接... (model: qwen3-max)
[agent] ✅ LLM 连接成功
```

如果 LLM 不可用，会自动降级到固定话术模式：

```
[agent] ❌ LLM 连接失败
[agent] fallback 到固定话术模式
```

### 预算控制

用户在前端配置的预算会传递给 Agent Hub：
- 买家 Agent 的 prompt 会包含预算上限
- 搜索商品时会过滤超出预算的商品
- 砍价时 LLM 被明确告知不能出价超过预算或商品标价

---

## 相关文档

- [Buyer Agent](../buyer-agent/README.md) - 买家代理服务
- [Seller Agent](../seller-agent/README.md) - 卖家客服服务
- [Market](../market/README.md) - 市场前端
